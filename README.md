# Face Attendance System
<h1> TÃ i khoáº£n Ä‘Äƒng nháº­p: admin </h1>
<h1> Máº­t kháº©u: admin </h1>
<div align="center">
  <img src="GitFolder/anh_1.png" alt="HÃ¬nh áº£nh 1" width="400"/>
  <img src="GitFolder/anh_2.png" alt="HÃ¬nh áº£nh 2" width="400"/>
</div>

<div align="center">
  <img src="GitFolder/anh_3.png" alt="HÃ¬nh áº£nh 3" width="400"/>
  <img src="GitFolder/anh_4.png" alt="HÃ¬nh áº£nh 4" width="400"/>
</div>

<div align="center">
  <img src="GitFolder/anh_5.png" alt="HÃ¬nh áº£nh 5" width="400"/>
  <img src="GitFolder/anh_6.png" alt="HÃ¬nh áº£nh 6" width="400"/>
</div>

<div align="center">
  <img src="GitFolder/anh_7.png" alt="HÃ¬nh áº£nh 7" width="400"/>
  <img src="GitFolder/anh_8.png" alt="HÃ¬nh áº£nh 8" width="400"/>
</div>

<div align="center">
  <img src="GitFolder/anh_9.png" alt="HÃ¬nh áº£nh 9" width="400"/>
  <img src="GitFolder/anh_10.png" alt="HÃ¬nh áº£nh 10" width="400"/>
</div>

---

Há»‡ thá»‘ng Ä‘iá»ƒm danh báº±ng khuÃ´n máº·t tÃ­ch há»£p vá»›i Odoo, sá»­ dá»¥ng AI vÃ  Computer Vision Ä‘á»ƒ xÃ¡c thá»±c khuÃ´n máº·t vá»›i Ä‘á»™ chÃ­nh xÃ¡c cao.

## Links

- ğŸŒ **Demo Website**: [https://attendance-system.ddns.net](https://attendance-system.ddns.net)


## CÃ´ng nghá»‡ sá»­ dá»¥ng

### Backend Technologies
- **Odoo 16+** - ERP framework chÃ­nh cho quáº£n lÃ½ nhÃ¢n sá»± vÃ  Ä‘iá»ƒm danh
- **Python 3.8+** - NgÃ´n ngá»¯ láº­p trÃ¬nh chÃ­nh
- **PostgreSQL 13** - CÆ¡ sá»Ÿ dá»¯ liá»‡u chÃ­nh
- **FastAPI 0.104.1** - Web framework cho Face Recognition API
- **Uvicorn** - ASGI server cho FastAPI

### Face Recognition & AI
- **InsightFace 0.7.3** - ThÆ° viá»‡n AI nháº­n diá»‡n khuÃ´n máº·t tiÃªn tiáº¿n
- **OpenCV 4.8.1** - Computer Vision cho xá»­ lÃ½ áº£nh vÃ  video
- **ONNX Runtime 1.18.1** - Runtime cho cÃ¡c mÃ´ hÃ¬nh AI
- **NumPy 1.24.3** - Xá»­ lÃ½ máº£ng vÃ  tÃ­nh toÃ¡n khoa há»c
- **Scikit-image 0.21.0** - Xá»­ lÃ½ áº£nh nÃ¢ng cao

### Frontend Technologies
- **Odoo Web Framework** - Giao diá»‡n web tÃ­ch há»£p sáºµn trong Odoo
- **HTML5/CSS3/JavaScript** - Frontend templates vÃ  static files
- **WebRTC** - Truy cáº­p camera trá»±c tiáº¿p tá»« trÃ¬nh duyá»‡t
- **Odoo QWeb Templates** - Template engine cá»§a Odoo

### Mobile Technologies (Flutter App)
- **Flutter 3.1.0+** - Cross-platform mobile framework
- **Dart** - NgÃ´n ngá»¯ láº­p trÃ¬nh cho Flutter
- **Camera Plugin 0.10.5** - Truy cáº­p camera trÃªn mobile
- **HTTP 1.1.0** - HTTP client cho API calls
- **Provider 6.1.1** - State management
- **Shared Preferences 2.2.2** - Local storage
- **Flutter Secure Storage 9.0.0** - Secure data storage
- **Permission Handler 11.0.1** - Quáº£n lÃ½ quyá»n truy cáº­p

### DevOps & Infrastructure
- **Docker & Docker Compose** - Containerization vÃ  orchestration
- **Git** - Version control system


### Advanced Features
- **Multiple Face Registration** - ÄÄƒng kÃ½ nhiá»u gÃ³c chá»¥p
- **Skin Tone Normalization** - Chuáº©n hÃ³a mÃ u da
- **Background Validation** - Kiá»ƒm tra ná»n áº£nh
- **Face Quality Enhancement** - TÄƒng cháº¥t lÆ°á»£ng áº£nh khuÃ´n máº·t
- **Embedding Diversity Analysis** - PhÃ¢n tÃ­ch Ä‘á»™ Ä‘a dáº¡ng Ä‘áº·c trÆ°ng
- **Real-time Processing** - Xá»­ lÃ½ thá»i gian thá»±c

## Kiáº¿n trÃºc há»‡ thá»‘ng

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   Mobile App     â”‚
                        â”‚   (Flutter)      â”‚
                        â”‚   REST API       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  |
                                  v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web Frontend  â”‚    â”‚   Odoo ERP       â”‚    â”‚  Face Recognitionâ”‚
â”‚   (WebRTC UI)   â”‚â”€â”€â”€â–¶â”‚   Controller     â”‚â”€â”€â”€â–¶â”‚   API Service   â”‚
â”‚                 â”‚    â”‚   (Python)       â”‚    â”‚   (FastAPI+AI)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
         â”‚              â”‚   PostgreSQL     â”‚             â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   Database       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚   (Odoo Data)    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 
                        
```

## Luá»“ng hoáº¡t Ä‘á»™ng

1. **NhÃ¢n viÃªn sá»­ dá»¥ng Face Attendance**: Truy cáº­p vÃ o menu "Face Attendance" trong Odoo
2. **Chá»¥p áº£nh khuÃ´n máº·t**: NhÃ¢n viÃªn chá»¥p áº£nh khuÃ´n máº·t qua webcam
3. **Gá»­i áº£nh vá» Controller**: Frontend gá»­i áº£nh vá» Odoo controller
4. **Gá»i API Face Recognition**: Controller gá»i API service Ä‘á»ƒ xÃ¡c thá»±c khuÃ´n máº·t
5. **Xá»­ lÃ½ báº±ng AI**: API service sá»­ dá»¥ng InsightFace vÃ  OpenCV Ä‘á»ƒ:
   - PhÃ¡t hiá»‡n vÃ  chuáº©n hÃ³a khuÃ´n máº·t trong áº£nh
   - TrÃ­ch xuáº¥t embedding vector tá»« khuÃ´n máº·t
   - So sÃ¡nh vá»›i cÃ¡c embedding Ä‘Ã£ lÆ°u (há»— trá»£ nhiá»u áº£nh)
   - Ãp dá»¥ng cÃ¡c bá»™ lá»c cháº¥t lÆ°á»£ng vÃ  validation
   - Tráº£ vá» káº¿t quáº£ xÃ¡c thá»±c vá»›i confidence score
6. **LÆ°u attendance**: Náº¿u xÃ¡c thá»±c thÃ nh cÃ´ng, lÆ°u báº£n ghi attendance vÃ o Odoo

## CÃ i Ä‘áº·t vÃ  cháº¡y

### YÃªu cáº§u há»‡ thá»‘ng
- Docker vÃ  Docker Compose
- Python 3.8+ (cho development)
- Webcam há»— trá»£

### Cháº¡y báº±ng Docker Compose


 **Cháº¡y há»‡ thá»‘ng**:
```bash
docker-compose up -d
```

 **Truy cáº­p á»©ng dá»¥ng**:
- Odoo: http://localhost:8069
- Face Recognition API: http://localhost:8000



### API Configuration
- URL: http://localhost:8000 (cÃ³ thá»ƒ thay Ä‘á»•i trong controller)
- Port: 8000
- CORS: ÄÃ£ cáº¥u hÃ¬nh Ä‘á»ƒ cho phÃ©p Odoo gá»i API

## Sá»­ dá»¥ng

### 1. ÄÄƒng kÃ½ khuÃ´n máº·t (láº§n Ä‘áº§u)
- ÄÄƒng nháº­p vÃ o Odoo vá»›i tÃ i khoáº£n nhÃ¢n viÃªn
- Truy cáº­p menu "Face Attendance"
- Chá»¥p áº£nh khuÃ´n máº·t vÃ  nháº¥n "Register Face"

### 2. Check-in/Check-out hÃ ng ngÃ y
- Truy cáº­p menu "Face Attendance"
- Chá»¥p áº£nh khuÃ´n máº·t
- Nháº¥n "Check In" hoáº·c "Check Out"

## API Endpoints

### Face Recognition API (Port 8000)

#### POST /face-recognition/verify
XÃ¡c thá»±c khuÃ´n máº·t cho check-in/check-out
```json
{
  "face_image": "base64_image_data",
  "action": "check_in|check_out",
  "employee_id": 123
}
```

#### POST /face-recognition/register
ÄÄƒng kÃ½ khuÃ´n máº·t cho nhÃ¢n viÃªn má»›i
```json
{
  "face_image": "base64_image_data"
}
```

#### GET /face-recognition/health
Kiá»ƒm tra tráº¡ng thÃ¡i API

### Odoo Controller Endpoints

#### POST /attendance/check_in
Check-in vá»›i xÃ¡c thá»±c khuÃ´n máº·t

#### POST /attendance/check_out
Check-out vá»›i xÃ¡c thá»±c khuÃ´n máº·t

#### POST /attendance/register_face
ÄÄƒng kÃ½ khuÃ´n máº·t

#### GET /attendance/face_api_health
Kiá»ƒm tra tráº¡ng thÃ¡i API face recognition

## TÃ­nh nÄƒng

### Face Recognition
- PhÃ¡t hiá»‡n khuÃ´n máº·t sá»­ dá»¥ng InsightFace AI models
- TrÃ­ch xuáº¥t embedding vectors vá»›i Ä‘á»™ chÃ­nh xÃ¡c cao
- Há»— trá»£ Ä‘Äƒng kÃ½ nhiá»u áº£nh tá»« cÃ¡c gÃ³c khÃ¡c nhau
- Chuáº©n hÃ³a mÃ u da vÃ  tÄƒng cháº¥t lÆ°á»£ng áº£nh
- Kiá»ƒm tra ná»n áº£nh vÃ  tá»· lá»‡ khung hÃ¬nh (3:4)
- So sÃ¡nh khuÃ´n máº·t vá»›i cosine similarity
- LÆ°u trá»¯ multiple embeddings cho má»—i nhÃ¢n viÃªn

### Security
- XÃ¡c thá»±c ngÆ°á»i dÃ¹ng Odoo
- Kiá»ƒm tra session
- Validation dá»¯ liá»‡u Ä‘áº§u vÃ o
- Error handling toÃ n diá»‡n

### User Experience
- Giao diá»‡n webcam responsive
- Real-time camera preview
- HÆ°á»›ng dáº«n Ä‘á»‹nh vá»‹ khuÃ´n máº·t
- ThÃ´ng bÃ¡o káº¿t quáº£ rÃµ rÃ ng

## Troubleshooting

### API khÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c
1. Kiá»ƒm tra service face_recognition_api Ä‘Ã£ cháº¡y chÆ°a
2. Kiá»ƒm tra port 8000 cÃ³ bá»‹ block khÃ´ng
3. Kiá»ƒm tra URL trong controller cÃ³ Ä‘Ãºng khÃ´ng

### Camera khÃ´ng hoáº¡t Ä‘á»™ng
1. Kiá»ƒm tra quyá»n truy cáº­p camera
2. Kiá»ƒm tra webcam cÃ³ Ä‘Æ°á»£c há»— trá»£ khÃ´ng
3. Thá»­ refresh trang

### Face recognition khÃ´ng chÃ­nh xÃ¡c
1. Äáº£m báº£o Ã¡nh sÃ¡ng Ä‘á»§ sÃ¡ng
2. KhuÃ´n máº·t pháº£i rÃµ rÃ ng, khÃ´ng bá»‹ che
3. Chá»‰ cÃ³ má»™t khuÃ´n máº·t trong khung hÃ¬nh

## Custom API Services Module - KhÃ¡i niá»‡m vÃ  Luá»“ng hoáº¡t Ä‘á»™ng chi tiáº¿t

### Kiáº¿n trÃºc Module Custom API Services

Module `custom_api_services` lÃ  trÃ¡i tim cá»§a há»‡ thá»‘ng Face Recognition, Ä‘Æ°á»£c thiáº¿t káº¿ theo kiáº¿n trÃºc phÃ¢n lá»›p rÃµ rÃ ng:

```
custom_api_services/
â”œâ”€â”€ main.py                    # Entry point - FastAPI application
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ config.py             # Cáº¥u hÃ¬nh toÃ n cá»¥c vÃ  thÃ´ng sá»‘ AI
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ routes.py         # REST API endpoints definition
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ face_recognition_service.py  # Business logic layer
â”‚   â”œâ”€â”€ core/                 # Core AI processing modules
â”‚   â”‚   â”œâ”€â”€ face_embeddings.py      # InsightFace embedding extraction
â”‚   â”‚   â”œâ”€â”€ face_detection.py       # Face detection algorithms
â”‚   â”‚   â”œâ”€â”€ face_alignment.py       # Face alignment and normalization
â”‚   â”‚   â”œâ”€â”€ skin_normalization.py   # Skin tone normalization
â”‚   â”‚   â”œâ”€â”€ canny_features.py       # Canny edge feature extraction
â”‚   â”‚   â”œâ”€â”€ image_processing.py     # Image preprocessing utilities
â”‚   â”‚   â”œâ”€â”€ validation.py           # Image validation rules
â”‚   â”‚   â””â”€â”€ file_operations.py      # File I/O operations
â”‚   â””â”€â”€ models/
â”‚       â””â”€â”€ face_models.py          # InsightFace model management
â”œâ”€â”€ employee_faces/           # LÆ°u trá»¯ áº£nh khuÃ´n máº·t nhÃ¢n viÃªn
â””â”€â”€ employee_canny_features/  # LÆ°u trá»¯ Canny features
```

### CÃ¡c khÃ¡i niá»‡m cá»‘t lÃµi cáº§n hiá»ƒu

#### 1. Face Embeddings (Vector Ä‘áº·c trÆ°ng) - **PHÆ¯Æ NG PHÃP CHÃNH**
- **Má»¥c Ä‘Ã­ch**: PhÆ°Æ¡ng phÃ¡p chÃ­nh Ä‘á»ƒ nháº­n diá»‡n khuÃ´n máº·t trong há»‡ thá»‘ng
- **Trá»ng sá»‘**: 85% trong quyáº¿t Ä‘á»‹nh cuá»‘i cÃ¹ng (káº¿t há»£p vá»›i Canny 15%)
- **NgÆ°á»¡ng**: 0.6 (COSINE_THRESHOLD trong config)
- **Äá»‹nh nghÄ©a**: Vector 512 chiá»u tá»« mÃ´ hÃ¬nh InsightFace ArcFace
- **Æ¯u Ä‘iá»ƒm**: Äá»™ chÃ­nh xÃ¡c cao, báº¥t biáº¿n vá»›i gÃ³c chá»¥p vÃ  Ã¡nh sÃ¡ng

#### 2. Canny Features (Äáº·c trÆ°ng biÃªn Canny) - **PHÆ¯Æ NG PHÃP Bá»” TRá»¢**
- **Má»¥c Ä‘Ã­ch**: Bá»• trá»£ cho embeddings, tÄƒng Ä‘á»™ tin cáº­y
- **Trá»ng sá»‘**: 15% trong quyáº¿t Ä‘á»‹nh cuá»‘i cÃ¹ng (káº¿t há»£p vá»›i Embeddings 85%)
- **Quy trÃ¬nh**: Canny edge detection â†’ contour extraction â†’ feature points comparison
- **Æ¯u Ä‘iá»ƒm**: Ãt bá»‹ áº£nh hÆ°á»Ÿng bá»Ÿi thay Ä‘á»•i Ã¡nh sÃ¡ng, xá»­ lÃ½ nhanh

#### 3. Skin Tone Normalization (Chuáº©n hÃ³a mÃ u da)
- **Má»¥c Ä‘Ã­ch**: Giáº£m thiá»ƒu áº£nh hÆ°á»Ÿng cá»§a Ä‘iá»u kiá»‡n Ã¡nh sÃ¡ng khÃ¡c nhau
- **PhÆ°Æ¡ng phÃ¡p**: PhÃ¢n tÃ­ch HSV, tÃ¬m Ä‘iá»ƒm da sÃ¡ng nháº¥t, Ä‘iá»u chá»‰nh toÃ n bá»™ vÃ¹ng máº·t
- **Ãp dá»¥ng**: Cáº£ registration vÃ  verification trÆ°á»›c khi trÃ­ch xuáº¥t embeddings vÃ  Canny features
- **Káº¿t quáº£**: TÄƒng Ä‘á»™ chÃ­nh xÃ¡c nháº­n diá»‡n trong Ä‘iá»u kiá»‡n Ã¡nh sÃ¡ng khÃ¡c nhau

#### 4. Image Validation (Kiá»ƒm tra tÃ­nh há»£p lá»‡ áº£nh)
- **Aspect Ratio**: Cháº¥p nháº­n tá»· lá»‡ 3:4 (0.75) hoáº·c 4:6 (0.667) vá»›i tolerance Â±5%
- **Background Color**: Kiá»ƒm tra ná»n tráº¯ng hoáº·c xanh báº±ng Euclidean distance
- **Ãp dá»¥ng**: Strict validation cho registration, lenient cho verification

#### 5. Face Detection (PhÃ¡t hiá»‡n khuÃ´n máº·t)
- **PhÆ°Æ¡ng phÃ¡p chÃ­nh**: InsightFace vá»›i confidence threshold â‰¥ 0.6
- **Fallback**: OpenCV Haar Cascade náº¿u InsightFace tháº¥t báº¡i
- **Xá»­ lÃ½**: Chá»‰ cháº¥p nháº­n 1 khuÃ´n máº·t, chá»n khuÃ´n máº·t lá»›n nháº¥t náº¿u cÃ³ nhiá»u

### Luá»“ng xá»­ lÃ½ chi tiáº¿t

#### A. Luá»“ng Ä‘Äƒng kÃ½ khuÃ´n máº·t (Registration Flow)

```mermaid
graph TD
    A[Upload Image] --> B[Image Validation]
    B --> C{Aspect Ratio 3:4?}
    C -->|No| D[Return Error]
    C -->|Yes| E[Background Color Check]
    E --> F{White/Blue Background?}
    F -->|No| G[Return Error]
    F -->|Yes| H[Face Detection]
    H --> I{Single Face Found?}
    I -->|No| J[Return Error]
    I -->|Yes| K[Skin Tone Normalization]
    K --> L[Embedding Extraction]
    L --> M[Canny Features Extraction]
    M --> N[Save Embeddings & Canny Features]
```

**Chi tiáº¿t tá»«ng bÆ°á»›c:**

1. **Image Validation** (`validation.py`):
   
   **BÆ°á»›c Ä‘áº§u tiÃªn**: Há»‡ thá»‘ng nháº­n áº£nh tá»« client vÃ  báº¯t Ä‘áº§u quÃ¡ trÃ¬nh kiá»ƒm tra tÃ­nh há»£p lá»‡.
   
   - **Kiá»ƒm tra tá»· lá»‡ khung hÃ¬nh**: Äo chiá»u rá»™ng vÃ  chiá»u cao cá»§a áº£nh, tÃ­nh tá»· lá»‡ `width/height`. Há»‡ thá»‘ng cháº¥p nháº­n tá»· lá»‡ 3:4 (0.75) hoáº·c 4:6 (0.667) vá»›i Ä‘á»™ sai lá»‡ch Â±5%. Náº¿u tá»· lá»‡ khÃ´ng Ä‘Ãºng, tráº£ vá» thÃ´ng bÃ¡o lá»—i ngay láº­p tá»©c.
   
   - **PhÃ¢n tÃ­ch mÃ u ná»n**: Láº¥y máº«u pixel tá»« 4 cáº¡nh viá»n cá»§a áº£nh (trÃªn, dÆ°á»›i, trÃ¡i, pháº£i), tÃ­nh mÃ u trung bÃ¬nh cá»§a vÃ¹ng viá»n. So sÃ¡nh vá»›i mÃ u chuáº©n (tráº¯ng RGB(255,255,255) hoáº·c cÃ¡c tÃ´ng xanh) báº±ng khoáº£ng cÃ¡ch Euclidean. Náº¿u khoáº£ng cÃ¡ch > ngÆ°á»¡ng cho phÃ©p, tá»« chá»‘i áº£nh.
   
   - **Káº¿t quáº£**: Náº¿u cáº£ hai Ä‘iá»u kiá»‡n Ä‘á»u thá»a mÃ£n, áº£nh Ä‘Æ°á»£c chuyá»ƒn sang bÆ°á»›c tiáº¿p theo. NgÆ°á»£c láº¡i, tráº£ vá» thÃ´ng bÃ¡o lá»—i cá»¥ thá»ƒ Ä‘á»ƒ ngÆ°á»i dÃ¹ng biáº¿t cÃ¡ch kháº¯c phá»¥c.

2. **Face Detection** (`face_detection.py`):
   
   **Tiáº¿p theo**: Sau khi áº£nh Ä‘Ã£ Ä‘Æ°á»£c validate, há»‡ thá»‘ng báº¯t Ä‘áº§u tÃ¬m kiáº¿m khuÃ´n máº·t trong áº£nh.
   
   - **PhÆ°Æ¡ng phÃ¡p chÃ­nh - InsightFace**: Sá»­ dá»¥ng mÃ´ hÃ¬nh AI InsightFace Ä‘á»ƒ phÃ¡t hiá»‡n khuÃ´n máº·t. MÃ´ hÃ¬nh nÃ y tráº£ vá» tá»a Ä‘á»™ bounding box (x, y, width, height) vÃ  confidence score cho má»—i khuÃ´n máº·t Ä‘Æ°á»£c phÃ¡t hiá»‡n. Chá»‰ cháº¥p nháº­n nhá»¯ng khuÃ´n máº·t cÃ³ confidence â‰¥ 0.6.
   
   - **PhÆ°Æ¡ng phÃ¡p dá»± phÃ²ng - OpenCV**: Náº¿u InsightFace khÃ´ng phÃ¡t hiá»‡n Ä‘Æ°á»£c khuÃ´n máº·t nÃ o, há»‡ thá»‘ng chuyá»ƒn sang sá»­ dá»¥ng Haar Cascade classifier cá»§a OpenCV vá»›i cÃ¡c tham sá»‘: scaleFactor=1.1, minNeighbors=4, minSize=(60,60).
   
   - **Lá»±a chá»n khuÃ´n máº·t**: Náº¿u phÃ¡t hiá»‡n Ä‘Æ°á»£c nhiá»u khuÃ´n máº·t, há»‡ thá»‘ng chá»n khuÃ´n máº·t cÃ³ diá»‡n tÃ­ch lá»›n nháº¥t (width Ã— height). Náº¿u khÃ´ng tÃ¬m tháº¥y khuÃ´n máº·t nÃ o, tráº£ vá» lá»—i "KhÃ´ng thá»ƒ phÃ¡t hiá»‡n khuÃ´n máº·t".

3. **Skin Tone Normalization** (`skin_normalization.py`):
   
   **BÆ°á»›c chuáº©n hÃ³a**: Sau khi Ä‘Ã£ xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c vá»‹ trÃ­ khuÃ´n máº·t, há»‡ thá»‘ng tiáº¿n hÃ nh chuáº©n hÃ³a mÃ u da Ä‘á»ƒ giáº£m áº£nh hÆ°á»Ÿng cá»§a Ã¡nh sÃ¡ng.
   
   - **Táº¡o vÃ¹ng quan tÃ¢m**: Má»Ÿ rá»™ng bounding box cá»§a khuÃ´n máº·t thÃªm 10% vá» má»—i phÃ­a Ä‘á»ƒ cÃ³ Ä‘á»§ context. Crop vÃ¹ng nÃ y tá»« áº£nh gá»‘c.
   
   - **PhÃ¢n tÃ­ch mÃ u da**: Chuyá»ƒn Ä‘á»•i vÃ¹ng khuÃ´n máº·t sang khÃ´ng gian mÃ u HSV. Táº¡o mask Ä‘á»ƒ phÃ¡t hiá»‡n vÃ¹ng da dá»±a trÃªn khoáº£ng giÃ¡ trá»‹ HSV Ä‘áº·c trÆ°ng cá»§a da ngÆ°á»i: H(0-25, 160-180), S(20-255), V(20-255).
   
   - **TÃ¬m Ä‘iá»ƒm reference**: Trong vÃ¹ng da Ä‘Ã£ Ä‘Æ°á»£c mask, tÃ¬m pixel cÃ³ Ä‘á»™ sÃ¡ng cao nháº¥t trong khÃ´ng gian Lab (L-channel). ÄÃ¢y sáº½ lÃ  Ä‘iá»ƒm chuáº©n Ä‘á»ƒ Ä‘iá»u chá»‰nh mÃ u.
   
   - **Ãp dá»¥ng normalization**: TÃ­nh vector Ä‘iá»u chá»‰nh mÃ u tá»« Ä‘iá»ƒm sÃ¡ng nháº¥t. Ãp dá»¥ng Ä‘iá»u chá»‰nh nÃ y lÃªn toÃ n bá»™ vÃ¹ng khuÃ´n máº·t vá»›i Ä‘á»™ máº¡nh 60% vÃ  sá»­ dá»¥ng Gaussian blur Ä‘á»ƒ táº¡o hiá»‡u á»©ng má»m máº¡i.

4. **Face Quality Enhancement** (`image_processing.py`):
   
   **BÆ°á»›c tÄƒng cháº¥t lÆ°á»£ng**: Vá»›i khuÃ´n máº·t Ä‘Ã£ Ä‘Æ°á»£c chuáº©n hÃ³a mÃ u da, há»‡ thá»‘ng tiáº¿p tá»¥c cáº£i thiá»‡n cháº¥t lÆ°á»£ng áº£nh.
   
   - **Má»Ÿ rá»™ng vÃ¹ng khuÃ´n máº·t**: TÄƒng kÃ­ch thÆ°á»›c bounding box thÃªm 20% vá» má»—i phÃ­a Ä‘á»ƒ cÃ³ thÃªm context xung quanh khuÃ´n máº·t. Äiá»u nÃ y giÃºp mÃ´ hÃ¬nh AI hoáº¡t Ä‘á»™ng tá»‘t hÆ¡n.
   
   - **Giáº£m nhiá»…u**: Ãp dá»¥ng Gaussian blur nháº¹ (kernel 3x3, sigma=0.5) Ä‘á»ƒ lÃ m má»‹n áº£nh vÃ  giáº£m nhiá»…u pixel.
   
   - **Cáº£i thiá»‡n Ä‘á»™ tÆ°Æ¡ng pháº£n**: Sá»­ dá»¥ng CLAHE (Contrast Limited Adaptive Histogram Equalization) vá»›i clipLimit=2.0 vÃ  tileGridSize=(8,8) Ä‘á»ƒ cÃ¢n báº±ng Ä‘á»™ tÆ°Æ¡ng pháº£n cá»¥c bá»™, lÃ m ná»•i báº­t cÃ¡c Ä‘áº·c Ä‘iá»ƒm khuÃ´n máº·t.
   
   - **TÄƒng Ä‘á»™ sáº¯c nÃ©t**: Ãp dá»¥ng unsharp masking filter Ä‘á»ƒ tÄƒng Ä‘á»™ sáº¯c nÃ©t cá»§a cÃ¡c cáº¡nh vÃ  Ä‘Æ°á»ng nÃ©t khuÃ´n máº·t mÃ  khÃ´ng táº¡o ra artifacts.

5. **Canny Features Extraction** (`canny_features.py`):
   
   **BÆ°á»›c trÃ­ch xuáº¥t Ä‘áº·c trÆ°ng chÃ­nh**: ÄÃ¢y lÃ  bÆ°á»›c quan trá»ng nháº¥t, trÃ­ch xuáº¥t Canny features Ä‘á»ƒ nháº­n diá»‡n khuÃ´n máº·t.
   
   - **Crop face region**: Cáº¯t vÃ¹ng khuÃ´n máº·t vá»›i margin 10% Ä‘á»ƒ cÃ³ Ä‘á»§ context xung quanh.
   
   - **Chuyá»ƒn Ä‘á»•i grayscale**: Convert áº£nh khuÃ´n máº·t sang áº£nh xÃ¡m Ä‘á»ƒ chuáº©n bá»‹ cho Canny edge detection.
   
   - **Resize chuáº©n**: Resize vá» kÃ­ch thÆ°á»›c 200x200 pixels Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh nháº¥t quÃ¡n.
   
   - **Gaussian blur**: Ãp dá»¥ng Gaussian blur (5x5 kernel) Ä‘á»ƒ giáº£m nhiá»…u trÆ°á»›c khi detect edges.
   
   - **Canny edge detection**: Ãp dá»¥ng thuáº­t toÃ¡n Canny vá»›i threshold tháº¥p=50, threshold cao=150 Ä‘á»ƒ phÃ¡t hiá»‡n cÃ¡c cáº¡nh trong khuÃ´n máº·t.
   
   - **Contour extraction**: TÃ¬m contours tá»« edges vÃ  trÃ­ch xuáº¥t feature points tá»« cÃ¡c contours nÃ y.
   
   - **LÆ°u trá»¯ features**: LÆ°u Canny features vÃ o file `employee_{id}_canny.npy`.

6. **Save Face Image**:
   
   **BÆ°á»›c lÆ°u trá»¯**: LÆ°u áº£nh khuÃ´n máº·t Ä‘Ã£ Ä‘Æ°á»£c crop vÃ  xá»­ lÃ½.
   
   - **Extract face region**: Cáº¯t chÃ­nh xÃ¡c vÃ¹ng khuÃ´n máº·t vá»›i margin 5% tá»« áº£nh gá»‘c.
   
   - **LÆ°u file**: LÆ°u áº£nh khuÃ´n máº·t vÃ o `employee_faces/employee_{id}.jpg` Ä‘á»ƒ sá»­ dá»¥ng cho cÃ¡c má»¥c Ä‘Ã­ch khÃ¡c.

#### B. Luá»“ng xÃ¡c thá»±c khuÃ´n máº·t (Verification Flow)

```mermaid
graph TD
    A[Capture Image] --> B[Image Preprocessing]
    B --> C[Face Detection]
    C --> D{Single Face Found?}
    D -->|No| E[Return Error]
    D -->|Yes| F[Skin Tone Normalization]
    F --> G[Embedding Extraction]
    G --> H[Canny Features Extraction]
    H --> I[Load Stored Data]
    I --> J[Compare Embeddings]
    J --> K[Compare Canny Features]
    K --> L[Combined Scoring: 85% Embedding + 15% Canny]
    L --> M{Final Score >= 0.6?}
    M -->|Yes| N[Authentication Success]
    M -->|No| O[Authentication Failed]
```

**Chi tiáº¿t quy trÃ¬nh verification:**

1. **Image Preprocessing**:
   
   **BÆ°á»›c khá»Ÿi Ä‘áº§u**: Khi nhÃ¢n viÃªn chá»¥p áº£nh Ä‘á»ƒ check-in/check-out, áº£nh Ä‘Æ°á»£c gá»­i Ä‘áº¿n API vÃ  tráº£i qua preprocessing pipeline.
   
   - **Process uploaded image**: Äá»c vÃ  decode áº£nh tá»« multipart form data.
   
   - **Preprocess image**: Resize vÃ  chuáº©n hÃ³a áº£nh Ä‘á»ƒ chuáº©n bá»‹ cho face detection.

2. **Face Detection vÃ  Validation**:
   
   **PhÃ¡t hiá»‡n khuÃ´n máº·t**: Sá»­ dá»¥ng InsightFace Ä‘á»ƒ detect faces trong áº£nh Ä‘Ã£ Ä‘Æ°á»£c preprocess.
   
   - **Kiá»ƒm tra sá»‘ lÆ°á»£ng faces**: Pháº£i cÃ³ Ä‘Ãºng 1 khuÃ´n máº·t, náº¿u khÃ´ng cÃ³ hoáº·c cÃ³ nhiá»u hÆ¡n 1 thÃ¬ tráº£ vá» lá»—i.
   
   - **Láº¥y face info**: TrÃ­ch xuáº¥t thÃ´ng tin bounding box vÃ  face object tá»« káº¿t quáº£ detection.

3. **Skin Tone Normalization**:
   
   **Chuáº©n hÃ³a mÃ u da**: Ãp dá»¥ng skin tone normalization lÃªn áº£nh gá»‘c (khÃ´ng pháº£i áº£nh Ä‘Ã£ preprocess).
   
   - **Normalize skin tone**: Sá»­ dá»¥ng face object vÃ  bounding box Ä‘á»ƒ chuáº©n hÃ³a mÃ u da.
   
   - **Preprocess normalized image**: Preprocess láº¡i áº£nh Ä‘Ã£ Ä‘Æ°á»£c normalize Ä‘á»ƒ chuáº©n bá»‹ cho Canny extraction.

4. **Embedding Extraction vÃ  Combined Scoring**:
   
   **TrÃ­ch xuáº¥t embeddings vÃ  Canny features**: Tá»« áº£nh Ä‘Ã£ Ä‘Æ°á»£c normalize, trÃ­ch xuáº¥t cáº£ embeddings vÃ  Canny features.
   
   - **Load stored data**: Äá»c embeddings vÃ  Canny features Ä‘Ã£ lÆ°u cá»§a nhÃ¢n viÃªn tá»« cÃ¡c file tÆ°Æ¡ng á»©ng.
   
   - **Kiá»ƒm tra registration**: Náº¿u nhÃ¢n viÃªn chÆ°a Ä‘Äƒng kÃ½ (khÃ´ng cÃ³ stored data), tráº£ vá» lá»—i.
   
   - **So sÃ¡nh embeddings**: Sá»­ dá»¥ng cosine similarity Ä‘á»ƒ so sÃ¡nh embeddings hiá»‡n táº¡i vá»›i embeddings Ä‘Ã£ lÆ°u.
   
   - **So sÃ¡nh Canny features**: Sá»­ dá»¥ng `compare_canny_features()` vá»›i threshold=0.1 Ä‘á»ƒ tÃ­nh Canny similarity.
   
   - **Combined scoring**: TÃ­nh Ä‘iá»ƒm cuá»‘i cÃ¹ng = 85% Ã— embedding_similarity + 15% Ã— canny_similarity
   
   - **Quyáº¿t Ä‘á»‹nh cuá»‘i cÃ¹ng**: 
     - Náº¿u `final_confidence >= COSINE_THRESHOLD` (0.6): **SUCCESS** - Cho phÃ©p check-in/check-out
     - Náº¿u khÃ´ng Ä‘áº¡t ngÆ°á»¡ng: **FAILED** - Tá»« chá»‘i vá»›i thÃ´ng bÃ¡o confidence score
   
   **Logging vÃ  feedback**: Ghi láº¡i embedding similarity, Canny similarity vÃ  final confidence score Ä‘á»ƒ tráº£ vá» cho client.

### CÃ¡c tÃ­nh nÄƒng nÃ¢ng cao

#### 1. Adaptive Thresholds
- Tá»± Ä‘á»™ng Ä‘iá»u chá»‰nh ngÆ°á»¡ng dá»±a trÃªn sá»‘ lÆ°á»£ng embeddings
- Strict mode cho registration, lenient mode cho verification

#### 2. Quality Assessment
- ÄÃ¡nh giÃ¡ cháº¥t lÆ°á»£ng áº£nh báº±ng Laplacian variance
- Tá»± Ä‘á»™ng enhancement khi cháº¥t lÆ°á»£ng tháº¥p
- Reject áº£nh quÃ¡ má» hoáº·c quÃ¡ tá»‘i

#### 3. Anti-Spoofing Measures
- Kiá»ƒm tra tÃ­nh nháº¥t quÃ¡n cá»§a embedding
- PhÃ¡t hiá»‡n áº£nh in hoáº·c mÃ n hÃ¬nh
- Validation background vÃ  lighting conditions

#### 4. Performance Optimization
- Lazy loading cá»§a InsightFace models
- Caching embeddings trong memory
- Batch processing cho multiple faces

### API Endpoints chi tiáº¿t

#### POST `/face-recognition/register`
**Input**: `employee_id` (Form), `action` (Form), `face_image` (File)
**Process**: Image validation â†’ Face detection â†’ Skin normalization â†’ Embedding extraction â†’ Canny features extraction â†’ Save single embedding
**Output**: Success/failure vá»›i detailed message vÃ  confidence score

#### POST `/face-recognition/register-augmented` ğŸš§ **ÄANG PHÃT TRIá»‚N**
**Input**: `employee_id` (Form), `face_image` (File - áº£nh 3x4)
**Process**: Augmentation pipeline (code cÃ³ sáºµn nhÆ°ng chÆ°a hoáº¡t Ä‘á»™ng á»•n Ä‘á»‹nh)
**Output**: Multiple embeddings (tÃ­nh nÄƒng Ä‘ang Ä‘Æ°á»£c hoÃ n thiá»‡n)

#### POST `/face-recognition/verify`  
**Input**: `employee_id` (Form), `action` (Form), `face_image` (File)
**Process**: Image preprocessing â†’ Face detection â†’ Skin normalization â†’ Embedding extraction â†’ Canny extraction â†’ **Single embedding comparison**
**Output**: Match result vá»›i combined confidence score (85% embedding + 15% Canny, ngÆ°á»¡ng 0.6)

#### POST `/face-recognition/verify-max-similarity` ğŸš§ **ÄANG PHÃT TRIá»‚N**
**Input**: `employee_id` (Form), `action` (Form), `face_image` (File)
**Process**: Max similarity verification (code cÃ³ sáºµn nhÆ°ng chÆ°a hoáº¡t Ä‘á»™ng á»•n Ä‘á»‹nh)
**Output**: Match result vá»›i max similarity (tÃ­nh nÄƒng Ä‘ang Ä‘Æ°á»£c hoÃ n thiá»‡n)

### ğŸ”¥ **CÃ”NG THá»¨C TÃNH TOÃN HIá»†N Táº I**

## **PHÆ¯Æ NG PHÃP ÄANG Sá»¬ Dá»¤NG: Single Embedding (á»”n Ä‘á»‹nh)**

#### 1. **Registration Formula (ÄÄƒng kÃ½ cÆ¡ báº£n)**
```
Input: 1 áº£nh khuÃ´n máº·t
Process: 
1. Image validation (aspect ratio 3:4, background color)
2. Face detection (InsightFace)
3. Skin tone normalization
4. Face alignment
5. Embedding extraction (512-dimensional vector)
6. Canny features extraction

Output: 
- 1 embedding file: employee_{id}_embedding_0.npy
- 1 Canny features file: employee_{id}_features.npy
```

#### 2. **Verification Formula (XÃ¡c thá»±c cÆ¡ báº£n)**
```
Input: Webcam image
Process:
1. Extract webcam embedding: E_webcam
2. Load stored embedding: E_stored
3. Calculate embedding similarity: S_embedding = cosine_similarity(E_webcam, E_stored)
4. Extract and compare Canny features: S_canny
5. Combined scoring: Final_Confidence = 0.85 Ã— S_embedding + 0.15 Ã— S_canny

Decision:
- if Final_Confidence â‰¥ 0.6: âœ… ACCEPT (Authentication Success)
- if Final_Confidence < 0.6: âŒ REJECT (Authentication Failed)
```

## **PHÆ¯Æ NG PHÃP ÄANG PHÃT TRIá»‚N: Augmented + Max Similarity** ğŸš§

#### 1. **Augmented Registration Formula (Äang hoÃ n thiá»‡n)**
```
Input: 1 áº£nh 3x4
Process:
1. Face detection vÃ  validation
2. Generate augmented variations (Ä‘ang debug)
3. Extract multiple embeddings (chÆ°a á»•n Ä‘á»‹nh)
4. Save multiple files (cÃ³ lá»—i trong quÃ¡ trÃ¬nh lÆ°u)

Status: Code cÃ³ sáºµn nhÆ°ng chÆ°a hoáº¡t Ä‘á»™ng Ä‘Ãºng
```

#### 2. **Max Similarity Verification Formula (Äang hoÃ n thiá»‡n)**
```
Input: Webcam image
Process:
1. Extract webcam embedding
2. Load multiple embeddings (cÃ³ thá»ƒ fail)
3. Calculate max similarity (chÆ°a á»•n Ä‘á»‹nh)

Status: TÃ­nh nÄƒng Ä‘ang Ä‘Æ°á»£c debug vÃ  hoÃ n thiá»‡n
```

#### 3. **Threshold Values vÃ  Ã nghÄ©a**
```
COSINE_THRESHOLD = 0.6          # NgÆ°á»¡ng cháº¥p nháº­n cuá»‘i cÃ¹ng (giá»‘ng ARCFACE_THRESHOLD)
EMBEDDING_WEIGHT = 0.85         # Trá»ng sá»‘ ArcFace embedding (85%)
CANNY_WEIGHT = 0.15            # Trá»ng sá»‘ Canny features (15%)
ARCFACE_THRESHOLD = 0.6        # NgÆ°á»¡ng ArcFace similarity chÃ­nh
LBP_ORB_THRESHOLD = 0.45       # NgÆ°á»¡ng LBP+ORB similarity (fallback)
CANNY_THRESHOLD = 0.15         # NgÆ°á»¡ng Canny similarity
```

#### 4. **Storage Structure (Cáº¥u trÃºc lÆ°u trá»¯)**
```
employee_embeddings/
â”œâ”€â”€ employee_1_embedding_0.npy    # Single 512-dim embedding
â”œâ”€â”€ employee_2_embedding_0.npy    
â””â”€â”€ employee_N_embedding_0.npy

employee_canny_features/
â”œâ”€â”€ employee_1_features.npy       # Canny edge features
â”œâ”€â”€ employee_2_features.npy
â””â”€â”€ employee_N_features.npy
```

#### POST `/face-recognition/compare`
**Input**: `face_image1` (File), `face_image2` (File)
**Process**: **CHá»ˆ DÃ™NG CHO TESTING** - Full InsightFace embedding comparison workflow
**Output**: Embedding similarity score vÃ  detailed analysis

#### DELETE `/face-recognition/employee/{id}`
**Process**: XÃ³a file áº£nh vÃ  Canny features cá»§a nhÃ¢n viÃªn
**Output**: Danh sÃ¡ch files Ä‘Ã£ xÃ³a vÃ  errors (náº¿u cÃ³)

#### GET `/face-recognition/health`
**Process**: Kiá»ƒm tra tráº¡ng thÃ¡i API, Ä‘áº¿m sá»‘ áº£nh vÃ  embeddings
**Output**: Status, OpenCV version, InsightFace availability, file counts

#### GET `/face-recognition/info`
**Process**: ThÃ´ng tin vá» API workflow vÃ  features
**Output**: Detailed workflow steps vÃ  endpoint descriptions

#### POST `/face-recognition/backfill-embeddings`
**Process**: **CHá»ˆ DÃ™NG CHO TESTING** - Táº¡o embeddings tá»« áº£nh cÃ³ sáºµn
**Output**: Sá»‘ lÆ°á»£ng embeddings Ä‘Æ°á»£c táº¡o vÃ  failed files

### ğŸ“Š **WORKFLOW COMPARISON - Cáº¢ HAI PHÆ¯Æ NG PHÃP CÃ“ Sáº´N**

#### **PhÆ°Æ¡ng phÃ¡p 1: Single Embedding (CÆ¡ báº£n)**
```
Registration: 1 áº£nh â†’ 1 embedding + Canny features â†’ LÆ°u 2 files
Verification: webcam â†’ 1 embedding â†’ So sÃ¡nh 1-1 â†’ Combined scoring (85% embedding + 15% Canny) â†’ Decision
Accuracy: ~85-92% (tÃ¹y thuá»™c cháº¥t lÆ°á»£ng áº£nh vÃ  Ä‘iá»u kiá»‡n Ã¡nh sÃ¡ng)
Storage: 2 files per employee
Threshold: 0.6 (combined confidence)
```

#### **PhÆ°Æ¡ng phÃ¡p 2: Augmented + Max Similarity (Äang phÃ¡t triá»ƒn)** ğŸš§
```
Registration: 1 áº£nh 3x4 â†’ Augmentation pipeline â†’ Multiple embeddings (chÆ°a á»•n Ä‘á»‹nh)
Verification: webcam â†’ Max similarity comparison (Ä‘ang debug)
Status: Code cÃ³ sáºµn nhÆ°ng chÆ°a hoáº¡t Ä‘á»™ng Ä‘Ãºng
Note: TÃ­nh nÄƒng Ä‘ang Ä‘Æ°á»£c hoÃ n thiá»‡n, chÆ°a sá»­ dá»¥ng trong production
```

---

### ğŸ”§ **Cáº¤U HÃŒNH VÃ€ TUNING**

#### **File Cáº¥u hÃ¬nh: `app/config.py`**
```python
# Thresholds chÃ­nh
COSINE_THRESHOLD = 0.6          # NgÆ°á»¡ng cháº¥p nháº­n cuá»‘i cÃ¹ng (giá»‘ng ARCFACE_THRESHOLD)
EMBEDDING_WEIGHT = 0.85         # Trá»ng sá»‘ ArcFace embeddings (85%)
CANNY_WEIGHT = 0.15            # Trá»ng sá»‘ Canny features (15%)
ARCFACE_THRESHOLD = 0.6        # NgÆ°á»¡ng ArcFace similarity
LBP_ORB_THRESHOLD = 0.45       # NgÆ°á»¡ng LBP+ORB similarity (fallback)
CANNY_THRESHOLD = 0.15         # NgÆ°á»¡ng Canny similarity

# Directories
EMPLOYEE_FACES_DIR = "employee_faces"
EMPLOYEE_CANNY_FEATURES_DIR = "employee_canny_features"  
EMPLOYEE_EMBEDDINGS_DIR = "employee_embeddings"
```

#### **Tuning Recommendations**
```
MÃ´i trÆ°á»ng Ã¡nh sÃ¡ng tá»‘t: COSINE_THRESHOLD = 0.75
MÃ´i trÆ°á»ng Ã¡nh sÃ¡ng kÃ©m: COSINE_THRESHOLD = 0.65
YÃªu cáº§u báº£o máº­t cao: COSINE_THRESHOLD = 0.8
YÃªu cáº§u user-friendly: COSINE_THRESHOLD = 0.6
```

### ğŸ“ **Cáº¤U TRÃšC FILE STORAGE HIá»†N Táº I**

#### **Single Embedding Storage**
```
employee_embeddings/
â”œâ”€â”€ employee_1_embedding_0.npy    # Single 512-dim embedding
â”œâ”€â”€ employee_2_embedding_0.npy    
â””â”€â”€ employee_N_embedding_0.npy

Format: numpy array shape (512,) - single embedding vector
```

#### **Canny Features Storage**
```
employee_canny_features/
â”œâ”€â”€ employee_1_features.npy      # Canny edge features
â”œâ”€â”€ employee_2_features.npy
â””â”€â”€ employee_N_features.npy

Format: numpy array vá»›i Canny contour points
```

### Troubleshooting vÃ  Monitoring

#### **Common Issues vá»›i Giáº£i phÃ¡p:**
1. **"KhÃ´ng thá»ƒ tÃ¬m tháº¥y khuÃ´n máº·t"**: 
   - Cáº£i thiá»‡n Ã¡nh sÃ¡ng, gÃ³c chá»¥p tháº³ng
   - Äáº£m báº£o áº£nh cÃ³ tá»· lá»‡ 3:4 vÃ  ná»n tráº¯ng/xanh
   - Kiá»ƒm tra chá»‰ cÃ³ 1 khuÃ´n máº·t trong áº£nh
   
2. **"Final confidence tháº¥p"**: 
   - Kiá»ƒm tra cháº¥t lÆ°á»£ng áº£nh webcam
   - Äáº£m báº£o cÃ¹ng ngÆ°á»i Ä‘Ã£ Ä‘Äƒng kÃ½
   - Xem embedding_similarity vÃ  canny_similarity trong response
   
3. **"Embeddings file not found"**: 
   - NhÃ¢n viÃªn chÆ°a Ä‘Äƒng kÃ½ hoáº·c file bá»‹ máº¥t
   - Cháº¡y láº¡i `/face-recognition/register`
   - Kiá»ƒm tra thÆ° má»¥c `employee_embeddings/`
   
4. **False positives (nháº­n nháº§m ngÆ°á»i khÃ¡c)**: 
   - TÄƒng COSINE_THRESHOLD lÃªn 0.75-0.8
   - Kiá»ƒm tra cháº¥t lÆ°á»£ng áº£nh Ä‘Äƒng kÃ½
   - Äáº£m báº£o background validation hoáº¡t Ä‘á»™ng
   
5. **False negatives (khÃ´ng nháº­n ra Ä‘Ãºng ngÆ°á»i)**: 
   - Giáº£m COSINE_THRESHOLD xuá»‘ng 0.65
   - Kiá»ƒm tra Ä‘iá»u kiá»‡n Ã¡nh sÃ¡ng khi Ä‘Äƒng kÃ½ vs verification
   - ÄÄƒng kÃ½ láº¡i vá»›i áº£nh cháº¥t lÆ°á»£ng tá»‘t hÆ¡n

#### **Performance Metrics Hiá»‡n táº¡i:**
- **Processing time**: ~200-400ms (single embedding comparison)
- **Memory usage**: ~500MB cho InsightFace models
- **Accuracy**: ~85-92% vá»›i single embedding + Canny features
- **Storage**: ~2KB per employee (1 embedding + Canny features)

#### **Monitoring Commands:**
```bash
# Kiá»ƒm tra health API
curl http://localhost:8000/face-recognition/health

# Xem thÃ´ng tin chi tiáº¿t
curl http://localhost:8000/face-recognition/info

# Kiá»ƒm tra embeddings cá»§a nhÃ¢n viÃªn
ls -la employee_embeddings/employee_123_embedding_0.npy

# Kiá»ƒm tra Canny features
ls -la employee_canny_features/employee_123_features.npy
```



## License

MIT License
